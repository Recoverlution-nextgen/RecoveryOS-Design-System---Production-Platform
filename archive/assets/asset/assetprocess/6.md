**React PortalSkinProvider** that:  
* Calls selectAssetSet()  
* **Preloads** the bundle (images/video poster/audio)  
* Applies a **CSS variable skin** to the whole shell  
* Handles **reduced motion** automatically (video → poster)  
* Gives you a clean usePortalSkin() hook for any component  
Drop this in and your OS shell becomes *skinnable, deterministic, instant*.  
  
```

// src/portal/PortalSkinProvider.tsx
import React, { createContext, useContext, useEffect, useMemo, useState } from "react";
import { selectAssetSet, type SelectedAssetSet } from "@/assets/selectAssetSet";
import type { AssetRegistry } from "@/assets/selectAsset";
import type { Lens, Surface } from "@/assets/mappings";

type PortalSkinState = {
  status: "idle" | "loading" | "ready" | "error";
  skin: SelectedAssetSet | null;
  error?: string;
};

type PortalSkinConfig = {
  registry: AssetRegistry;
  surface: Surface;
  lens?: Lens;
  intent:
    | "portal_shell"
    | "marketing_keynote"
    | "journeys_install"
    | "navicues_feed"
    | "toolkit_read"
    | "wellbeing_session"
    | "state_checkin"
    | "proof_vault"
    | "console_dashboard"
    | "command_center"
    | "trust_layer";
  schemaIds?: string[];
  pillarIds?: string[];
  proofFit?: string[];
  maxWidth?: number;

  // If omitted, provider auto-detects system reduced motion preference
  prefersReducedMotion?: boolean;

  // If true, attempts to preload audio (use sparingly)
  preloadAudio?: boolean;

  // CSS tuning knobs (optional)
  glassBlurPx?: number;
  grainOpacity?: number;
  overlayOpacity?: number;
};

const PortalSkinContext = createContext<PortalSkinState>({
  status: "idle",
  skin: null,
});

function preloadImage(url: string) {
  return new Promise<void>((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve();
    img.onerror = () => reject(new Error(`Image preload failed: ${url}`));
    img.src = url;
  });
}

function preloadVideo(url: string) {
  // Preload video metadata only (fast + safe)
  return new Promise<void>((resolve, reject) => {
    const video = document.createElement("video");
    video.preload = "metadata";
    video.onloadedmetadata = () => resolve();
    video.onerror = () => reject(new Error(`Video preload failed: ${url}`));
    video.src = url;
  });
}

function preloadAudio(url: string) {
  // Metadata only to avoid aggressive network use
  return new Promise<void>((resolve, reject) => {
    const audio = document.createElement("audio");
    audio.preload = "metadata";
    audio.onloadedmetadata = () => resolve();
    audio.onerror = () => reject(new Error(`Audio preload failed: ${url}`));
    audio.src = url;
  });
}

/**
 * Applies the skin via CSS variables.
 * Use these variables in your CSS/Tailwind layer (examples below).
 */
function applySkinToRoot(opts: {
  root: HTMLElement;
  skin: SelectedAssetSet;
  glassBlurPx: number;
  grainOpacity: number;
  overlayOpacity: number;
}) {
  const { root, skin, glassBlurPx, grainOpacity, overlayOpacity } = opts;

  // Background can be an image or video or poster
  const bg = skin.background;
  const bgUrl = bg?.src ?? "";
  const bgType = bg?.type ?? "";

  // Overlays
  const grainUrl = skin.grain?.src ?? "";
  const glassUrl = skin.glass?.src ?? "";
  const overlayUrl = skin.overlay?.src ?? "";
  const sealUrl = skin.sealPulse?.src ?? "";
  const receiptUrl = skin.receiptTexture?.src ?? "";

  root.style.setProperty("--ros-bg-url", bgUrl ? `url("${bgUrl}")` : "none");
  root.style.setProperty("--ros-bg-type", bgType);
  root.style.setProperty("--ros-grain-url", grainUrl ? `url("${grainUrl}")` : "none");
  root.style.setProperty("--ros-glass-url", glassUrl ? `url("${glassUrl}")` : "none");
  root.style.setProperty("--ros-overlay-url", overlayUrl ? `url("${overlayUrl}")` : "none");
  root.style.setProperty("--ros-seal-url", sealUrl ? `url("${sealUrl}")` : "none");
  root.style.setProperty("--ros-receipt-url", receiptUrl ? `url("${receiptUrl}")` : "none");

  // Tunables
  root.style.setProperty("--ros-glass-blur", `${glassBlurPx}px`);
  root.style.setProperty("--ros-grain-opacity", `${grainOpacity}`);
  root.style.setProperty("--ros-overlay-opacity", `${overlayOpacity}`);
}

export function PortalSkinProvider({
  config,
  children,
  className,
}: {
  config: PortalSkinConfig;
  children: React.ReactNode;
  className?: string;
}) {
  const [state, setState] = useState<PortalSkinState>({ status: "idle", skin: null });

  const prefersReducedMotion = useMemo(() => {
    if (typeof config.prefersReducedMotion === "boolean") return config.prefersReducedMotion;
    if (typeof window === "undefined") return false;
    return window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches ?? false;
  }, [config.prefersReducedMotion]);

  const maxWidth = useMemo(() => {
    if (typeof config.maxWidth === "number") return config.maxWidth;
    if (typeof window === "undefined") return 1920;
    return Math.min(2560, Math.max(1280, window.innerWidth * 2));
  }, [config.maxWidth]);

  const skin = useMemo(() => {
    return selectAssetSet({
      registry: config.registry,
      surface: config.surface,
      lens: config.lens,
      intent: config.intent,
      schemaIds: config.schemaIds,
      pillarIds: config.pillarIds,
      proofFit: config.proofFit,
      maxWidth,
      prefersReducedMotion,
      allowMotion: true,
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    config.registry,
    config.surface,
    config.lens,
    config.intent,
    JSON.stringify(config.schemaIds ?? []),
    JSON.stringify(config.pillarIds ?? []),
    JSON.stringify(config.proofFit ?? []),
    maxWidth,
    prefersReducedMotion,
  ]);

  useEffect(() => {
    let cancelled = false;

    async function run() {
      try {
        setState({ status: "loading", skin: null });

        const tasks: Promise<void>[] = [];

        // Background
        if (skin.background?.kind === "image" && skin.background.src) tasks.push(preloadImage(skin.background.src));
        if (skin.background?.kind === "video" && skin.background.src) {
          // If reduced-motion, background src is already a poster image.
          // But if not, preload video metadata + poster if present.
          tasks.push(preloadVideo(skin.background.src));
          if (skin.background.poster?.src) tasks.push(preloadImage(skin.background.poster.src));
        }

        // Universal overlays
        if (skin.grain?.src) tasks.push(preloadImage(skin.grain.src));
        if (skin.glass?.src) tasks.push(preloadImage(skin.glass.src));
        if (skin.overlay?.src) tasks.push(preloadImage(skin.overlay.src));
        if (skin.sealPulse?.src) tasks.push(preloadImage(skin.sealPulse.src));
        if (skin.receiptTexture?.src) tasks.push(preloadImage(skin.receiptTexture.src));

        // Audio (optional)
        if (config.preloadAudio && skin.audioBed?.src) tasks.push(preloadAudio(skin.audioBed.src));

        await Promise.allSettled(tasks);

        if (cancelled) return;

        // Apply CSS variables at root wrapper
        const root = document.getElementById("recoveryos-portal-root");
        if (root) {
          applySkinToRoot({
            root,
            skin,
            glassBlurPx: config.glassBlurPx ?? 18,
            grainOpacity: config.grainOpacity ?? 0.35,
            overlayOpacity: config.overlayOpacity ?? 0.55,
          });
        }

        setState({
          status: "ready",
          skin,
        });
      } catch (e: any) {
        if (cancelled) return;
        setState({ status: "error", skin: null, error: e?.message ?? "Unknown error" });
      }
    }

    run();
    return () => {
      cancelled = true;
    };
  }, [skin, config.preloadAudio, config.glassBlurPx, config.grainOpacity, config.overlayOpacity]);

  return (
    <PortalSkinContext.Provider value={state}>
      <div id="recoveryos-portal-root" className={className ?? ""}>
        {children}
      </div>
    </PortalSkinContext.Provider>
  );
}

export function usePortalSkin() {
  return useContext(PortalSkinContext);
}

```
  
## **Minimal CSS usage (Tailwind-friendly)**  
Use these variables anywhere in your shell layout.  
```

/* src/styles/portal-skin.css */

.portal-skin {
  position: relative;
  min-height: 100vh;
  background-image: var(--ros-bg-url);
  background-size: cover;
  background-position: center;
}

/* Grain overlay */
.portal-skin::before {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background-image: var(--ros-grain-url);
  background-size: 512px 512px;
  opacity: var(--ros-grain-opacity, 0.35);
  mix-blend-mode: overlay;
}

/* Glass + overlay stack */
.portal-skin::after {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background-image: var(--ros-overlay-url), var(--ros-glass-url);
  background-size: cover, cover;
  opacity: var(--ros-overlay-opacity, 0.55);
  filter: blur(var(--ros-glass-blur, 18px));
}

```
In React:  
```

<PortalSkinProvider
  config={{
    registry,
    surface: "cmp_portal_shell",
    lens: "individual",
    intent: "portal_shell",
    schemaIds: ["schema_real_life_run"],
    preloadAudio: false,
  }}
  className="portal-skin"
>
  <App />
</PortalSkinProvider>

```
  
## **Optional (but moon): “skin warnings”**  
Any asset budget warnings are already inside the selected set:  
```

const { skin, status } = usePortalSkin();
skin?.warnings?.forEach(console.warn);

```
